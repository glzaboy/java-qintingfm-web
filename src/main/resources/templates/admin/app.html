<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout-adminlte}">
<head>
    <title>设置选项</title>
    <meta name="Keywords" content="资讯,博客,时事要闻,qintingfm,microtf">
    <meta name="description" content="资讯,博客,时事要闻">

</head>
<body>
<ul id="mainnav-menu" class="list-group" layout:fragment="menu"
    th:include="fragments/common::menu(${'/admin/miniApp/saveapp'})"></ul>
    <div layout:fragment="content" th:include="fragments/common-adminlte::form(${form1},@{/admin/miniApp/saveapp})" xmlns:th="http://www.w3.org/1999/html">
    </div>


    <div layout:fragment="footjs">
        <script>
            (function (factory) {
                "use strict";
                if (typeof define === "function" && define.amd) {
                    // AMD. Register as an anonymous module.
                    define(["jquery"], factory);
                } else if (typeof exports === "object") {
                    // Node. Does not work with strict CommonJS, but
                    // only CommonJS-like environments that support module.exports,
                    // like Node.
                    module.exports = factory(require("jquery"));
                } else {
                    factory( (typeof(jQuery) != 'undefined') ? jQuery : window.Zepto );
                }

            }(function ($){
                // the base DOM structure needed to create a modal
                var templates = {
                    dialog:
                        "<div class=\"modal fade jquerydialog\">\n" +
                        "    <div class=\"modal-dialog\">\n" +
                        "        <div class=\"modal-content\">\n" +
                        "            <div class=\"modal-header\">\n" +
                        "                <h4 class=\"modal-title\">标题</h4>\n" +
                        "                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\">\n" +
                        "                    <span aria-hidden=\"true\">&times;</span>\n" +
                        "                </button>\n" +
                        "            </div>\n" +
                        "            <div class=\"modal-body\"></div>\n" +
                        "            <div class=\"modal-footer\"></div>\n" +
                        "        </div>\n" +
                        "    </div>\n" +
                        "</div>",
                };
                function each(collection, iterator) {
                    var index = 0;
                    $.each(collection, function(key, value) {
                        iterator(key, value, index++);
                    });
                }
                function processCallback(e, dialog, callback) {
                    e.stopPropagation();
                    e.preventDefault();

                    // by default we assume a callback will get rid of the dialog,
                    // although it is given the opportunity to override this

                    // so, if the callback can be invoked and it *explicitly returns false*
                    // then we'll set a flag to keep the dialog active...
                    var preserveDialog = $.isFunction(callback) && callback(e) === false;

                    // ... otherwise we'll bin it
                    if (!preserveDialog) {
                        Plugin("remove");
                    }
                }
                var dialog = function (element, options) {
                    this.$element      = $(element);
                    this.options       = $.extend({}, dialog.DEFAULTS, options);
                    console.log(this.options);
                    var body = this.$element.find(".modal-body");
                    var buttonStr = "";
                    var callbacks = {
                        onEscape: options.onEscape
                    };
                    each(this.options.buttons, function(key, button) {

                        // @TODO I don't like this string appending to itself; bit dirty. Needs reworking
                        // can we just build up button elements instead? slower but neater. Then button
                        // can just become a template too
                        buttonStr += "<button data-bb-handler='" + key + "' type='button' class='btn " + button.className + "'>" + button.label + "</button>";
                        callbacks[key] = button.callback;
                    });

                    // if (this.options.title) {
                    //     body.before(templates.header);
                    // }
                    if (this.options.title) {
                        this.$element.find(".modal-title").html(this.options.title);
                    }
                    if (this.options.url) {
                        this.load(this.options.url);
                    }else{
                        this.$element.find('.modal-body').html(this.options.message);
                    }
                    if (buttonStr.length) {
                        this.$element.find(".modal-footer").html(buttonStr);
                    }else{
                        this.$element.find(".modal-footer").hide();
                    }
                    this.$element.on('click',".modal-footer button", function(e) {
                        var callbackKey = $(this).data("bb-handler");
                        processCallback(e, dialog, callbacks[callbackKey]);

                    });
                    this.$element.on('hidden.bs.modal', function (e) {
                        this.remove();
                    })
                    this.$element.modal(this.options);
                };
                dialog.DEFAULTS={
                    title:'提示消息',
                    remote:'',
                    backdrop: true,
                    keyboard: true,
                    show: true
                };
                dialog.prototype.hide=function (){
                    this.$element.modal('show');
                    this.$element.modal('hide');
                };
                dialog.prototype.show=function (){
                    this.$element.find('.modal-dialog').removeClass("modal-xl").removeClass("modal-lg").removeClass("modal-sm");
                    if(this.options.type){
                        this.$element.find('.modal-dialog').addClass(this.options.type);
                    }
                    this.$element.modal('show');
                };
                dialog.prototype.load=function (url){
                    this.$element
                        .find('.modal-body')
                        .load(url, $.proxy(function () {
                            this.$element.trigger('loaded.bs.modal')
                        }, this));
                    this.$element.modal('show');
                };

                // Dialog PLUGIN DEFINITION
                // =======================

                function Plugin(option, _relatedTarget) {
                    var jquerydialog=$('.jquerydialog');
                    if(jquerydialog.length){
                        jquerydialog.each(function () {
                            var $this   = $(this);
                            var options = $.extend({}, dialog.DEFAULTS, $this.data(), typeof option == 'object' && option);
                            data = new dialog(this, options);
                            if (typeof option == 'string') data[option](_relatedTarget);
                            else if (options.show) data.show(_relatedTarget);
                        });
                    }else{
                        return $(templates.dialog).each(function () {
                            var $this   = $(this);
                            var options = $.extend({}, dialog.DEFAULTS, $this.data(), typeof option == 'object' && option);

                            data = new dialog(this, options);
                            if (typeof option == 'string') data[option](_relatedTarget);
                            else if (options.show) data.show(_relatedTarget);
                        });
                    }
                }
                var old = $.dialog;
                $.dialog             = Plugin;
                $.dialog.Constructor = dialog;
                $.dialog.noConflict = function () {
                    $.dialog = old;
                    return this;
                };
            }));
        </script>
        <script th:inline="javascript">
            $(document).ready(function (){
                $('.select2bs4').select2({
                    theme: 'bootstrap4'
                });
                $.extend({
                    'createHtmlEdit':function(){
                            ClassicEditor
                                .create(document.querySelector('.htmlEditor'), {
                                    toolbar: {
                                        items: [
                                            'heading',
                                            'bold',
                                            'italic',
                                            'underline',
                                            'strikethrough',
                                            'fontColor',
                                            'undo',
                                            'redo',
                                            '|',
                                            'link',
                                            'imageUpload',
                                            '|',
                                            'bulletedList',
                                            'numberedList',
                                            'alignment',
                                            '|',
                                            'blockQuote',
                                            'insertTable',
                                            'removeFormat'
                                        ]
                                    },
                                    language: 'zh-cn',
                                    image: {
                                        toolbar: [
                                            'imageTextAlternative',
                                            '|',
                                            'imageStyle:full',
                                            'imageStyle:side'
                                        ]
                                    },
                                    table: {
                                        contentToolbar: [
                                            'tableColumn',
                                            'tableRow',
                                            'mergeTableCells',
                                            'tableCellProperties',
                                            'tableProperties'
                                        ]
                                    },
                                    simpleUpload: {
                                        uploadUrl: /*[[@{'/blog/uploadImage'}]]*/''
                                    },
                                    licenseKey: '',
                                })
                                .then(editor => {
                                    window.editor = editor;
                                })
                                .catch(error => {
                                    console.error(error);
                                });
                            ClassicEditor
                                .create(document.querySelector('.htmlEditUpload'), {
                                    toolbar: {
                                        items: [
                                            'bold',
                                            'italic',
                                            'underline',
                                            'strikethrough',
                                            'fontColor',
                                            '|',
                                            'blockQuote',
                                            '|',
                                            'removeFormat'
                                        ]
                                    },
                                    language: 'zh-cn',
                                    licenseKey: '',
                                })
                                .then(editor => {
                                    window.editor = editor;
                                })
                                .catch(error => {
                                    console.error(error);
                                });
                    }
                });
                /**
                 * link ajax ajaxask
                 */
                $('body').on('req.ajax','.ajax',function(e){
                    var linkobj=$(this);
                    var title = linkobj.attr('title');
                    if (!title) {
                        title = linkobj.text();
                    }
                    var url = $(this).attr('href');
                    console.log('url'+url);
                    if(linkobj.data('ajaxing')){
                        $(document).Toasts('create', {
                            autohide: true,
                            delay: 5000,
                            class: 'bg-info',
                            body: '程序已经提交中了，请稍后片刻。'
                        });
                        return false;
                    }
                    linkobj.data('ajaxing',true);
                    $.ajax({
                            type : 'GET',
                            url : url,
                            dataType : 'json',
                            'data':{form:'.ajax'}
                        }
                    ).done(function(data) {
                        console.log(data);
                        if(data.linkTextChange){
                            linkobj.text(data.linkTextChange)
                        }
                        if(data.autoJump){
                            window.setTimeout(function() {
                                window.location.href = data.link?data.link:window.location.href;
                            }, data.autoJump*1000);
                        }
                        if(data.autoHide){
                            if(typeof data.autoHide ==='string' && linkobj.parents(data.autoHide).length){
                                linkobj.parents(data.autoHide).hide(1000,function (){$(this).remove();});
                            }else{
                                linkobj.hide(1000,function (){$(this).remove();});
                            }
                        }
                        if(data.message){
                            if (data.link && data.link.length>0) {
                                let $dialogoption={};
                                $dialogoption.message=data.message;
                                $dialogoption.title='提示信息';
                                $dialogoption.buttons={};
                                $dialogoption.buttons.ok = {
                                    label : '确定',
                                    className: "btn-primary",
                                    callback : function() {
                                        window.location.href = data.link;
                                    }
                                } ;
                            } else {
                                $(document).Toasts('create', {
                                    autohide: true,
                                    delay: 5000,
                                    class: 'bg-info',
                                    body: data.message
                                });
                            }
                            $.dialog("remove");
                            $.dialog($dialogoption);
                        }
                    }).fail(function (jqXHR, textStatus) {
                        console.error(textStatus);
                        $(document).Toasts('create', {
                            autohide: true,
                            delay: 5000,
                            class: 'bg-danger',
                            body: '提交数据出错，可能是服务器正在维护或是网络问题，请稍后再试。'
                        })
                    }).always(function (xx){
                        linkobj.data('ajaxing',false);
                    });
                });
                $('body').on('submit','form.ajaxform',function(e) {
                    e.preventDefault();
                    var jqueryfrom = $(this);
                    var validateForm = jqueryfrom.validate({
                        errorElement: 'span',
                        errorPlacement: function (error, element) {
                            error.addClass('invalid-feedback');
                            element.closest('.form-group').append(error);
                        },
                        highlight: function (element, errorClass, validClass) {
                            $(element).addClass('is-invalid');
                        },
                        unhighlight: function (element, errorClass, validClass) {
                            $(element).removeClass('is-invalid');
                        }
                    });
                    if (jqueryfrom.data('submiting')) {
                        $(document).Toasts('create', {
                            autohide: true,
                            delay: 5000,
                            class: 'bg-warning',
                            body: '程序已经提交中了，请稍后片刻。'
                        })
                        return false;
                    }
                    jqueryfrom.data('submiting', 1);
                    var options = {};
                    options.url = jqueryfrom.attr('action') ? jqueryfrom.attr('action') : window.location.href;
                    options.type = jqueryfrom.attr('method') ? jqueryfrom.attr('method') : 'GET';
                    options.data = jqueryfrom.serializeArray();
                    options.dataType = 'json';
                    if (options.type.toUpperCase() == 'GET') {
                        var queryString = $.param(options.data);
                        options.url += (options.url.indexOf('?') >= 0 ? '&' : '?') + queryString;
                        options.data = null;  // data is null for 'get'
                    }
                    validateForm.resetForm();
                    $.ajax(options)
                        .done(function (data, statusText) {
                            console.log(data);
                            if (data.message) {
                                if (data.link && data.link.length > 0) {
                                    let $dialogoption={};
                                    $dialogoption.message=data.message;
                                    $dialogoption.title='提示信息';
                                    $dialogoption.buttons={};
                                    $dialogoption.type='modal-sm';
                                    if (data.link && data.link.length>0) {
                                        $dialogoption.buttons.ok = {
                                            label : '确定',
                                            className: "btn-primary",
                                            callback : function() {
                                                window.location.href = data.link;
                                            }
                                        } ;
                                    } else {
                                        $dialogoption.buttons.ok = {
                                            label : '确定',
                                            className: "btn-primary",
                                            callback : function() {
                                            }
                                        } ;
                                    }
                                    $.dialog($dialogoption);
                                }else{
                                    $(document).Toasts('create', {
                                        autohide: true,
                                        delay: 5000,
                                        class: 'bg-info',
                                        body: data.message
                                    });
                                }
                            }
                            if (data.autoJump) {
                                window.setTimeout(function () {
                                    window.location.href = data.link ? $.escapeurl(data.link) : window.location.href;
                                }, data.autoJump * 1000);
                            }
                            if (data.error) {
                                console.log(data.error);
                                validateForm.showErrors(data.error);
                            }
                        }).fail(function (jqXHR, statusText) {
                            console.error(textStatus);
                            $(document).Toasts('create', {
                                autohide: true,
                                delay: 5000,
                                class: 'bg-danger',
                                body: '提交数据出错，可能是服务器正在维护或是网络问题，请稍后再试。'
                            })
                    }).always(function () {
                        jqueryfrom.data('submiting', 0);
                        console.log("complete");
                    });
                });
                $('body').on('click','.ajaxdialog',function(e){
                    e.preventDefault();
                    var linkobj=$(this);
                    var title=linkobj.attr('title');
                    if(!title){
                        title=linkobj.text();
                    }
                    var url=linkobj.attr('href');
                    let $dialogoption={};
                    $dialogoption.url=url;
                    $dialogoption.title=title;
                    $dialogoption.buttons={};
                    $dialogoption.type='modal-xl';
                    $dialogoption.buttons.ok = {
                        label : '提交',
                        className: "btn-primary",
                        callback : function(event){
                            var form=$('.jquerydialog').find('form');
                            if(form.length){
                                form.trigger('submit');
                            }
                            return false;
                        }
                    } ;
                    $dialogoption.buttons.cancel = {
                        label : '取消',
                        className: "btn",
                        callback : function() {
                        }
                    } ;
                    return $.dialog($dialogoption);
                });
                $('body').on('click','.ajaxask,.ajax',function(e){
                    e.preventDefault();
                    var linkobj=$(this);
                    if(!linkobj.hasClass("ajax")){
                        linkobj.addClass("ajax");
                    }
                    if(linkobj.hasClass("ajaxask")){
                        var asktext = linkobj.data('asktext') ? linkobj.data('asktext') : "您确定要" + linkobj.text()+ "?";
                        let $dialogoption={};
                        $dialogoption.message=asktext;
                        $dialogoption.title='提示信息';
                        $dialogoption.buttons={};
                        $dialogoption.type='modal-lg';
                        $dialogoption.buttons.ok = {
                            label : '确定',
                            className: "btn-primary",
                            callback : function() {
                                linkobj.trigger('req.ajax')
                            }
                        } ;
                        $dialogoption.buttons.cancel = {
                            label : '取消',
                            className: "btn",
                            callback : function() {
                            }
                        } ;
                        return $.dialog($dialogoption);
                    };
                    $(this).trigger('req.ajax');
                });
            })
        </script>
    </div>
</body>
</html>